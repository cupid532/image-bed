version: '3.8'

services:
  web:
    build: .
    container_name: image_bed
    restart: unless-stopped
    ports:
      - "8000:8000"
    volumes:
      - /data/image_bed/images:/data/images
      - /data/image_bed/db:/app/db
    environment:
      - SECRET_KEY=${SECRET_KEY:-django-insecure-please-change-this-in-production}
      - DEBUG=${DEBUG:-False}
      - ALLOWED_HOSTS=${ALLOWED_HOSTS:-localhost,127.0.0.1}
      - API_TOKEN=${API_TOKEN}
      - REQUIRE_AUTH=${REQUIRE_AUTH:-True}
      - MAX_UPLOAD_SIZE=${MAX_UPLOAD_SIZE:-10485760}
      - ENABLE_IMAGE_COMPRESSION=${ENABLE_IMAGE_COMPRESSION:-True}
      - COMPRESSION_QUALITY=${COMPRESSION_QUALITY:-85}
      - MAX_IMAGE_DIMENSION=${MAX_IMAGE_DIMENSION:-4096}
      - MEDIA_ROOT=/data/images
    networks:
      - image_bed_network

  nginx:
    image: nginx:alpine
    container_name: image_bed_nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      - /data/image_bed/images:/data/images:ro
      - /data/image_bed/certbot:/etc/letsencrypt:ro
      - /data/image_bed/certbot-www:/var/www/certbot:ro
    depends_on:
      - web
    networks:
      - image_bed_network

networks:
  image_bed_network:
    driver: bridge
